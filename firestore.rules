rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // KullanÄ±cÄ±lar koleksiyonu
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // DeviceId ile arama iÃ§in
      allow read: if request.auth != null;
      
      // SM-2 Spaced Repetition KartlarÄ±
      match /sm2_cards/{cardId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma PlanlarÄ±
      match /daily_plans/{planId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Sistem yapÄ±landÄ±rmasÄ± (Admin kodu vb.)
    match /configs/settings {
      allow read: if request.auth != null;
    }
    
    // User DNA - Veri BankasÄ±
    match /user_dna/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // KullanÄ±cÄ± PuanlarÄ±
    match /user_points/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Ä°ÅŸlem geÃ§miÅŸi
      match /transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Sorular koleksiyonu  
    match /questions/{questionId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Spaced Repetition - Tekrar KartlarÄ±
    match /user_reviews/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /cards/{cardId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Duyurular - Herkes okusun
    match /announcements/{announcementId} {
      allow read: if true;
      allow write: if false;
    }
    
    // GÃ¼nlÃ¼k Snapshots
    match /daily_snapshots/{snapshotId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Soru OturumlarÄ±
    match /question_sessions/{sessionId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Ã–ÄŸrenme Etkinlikleri
    match /learning_events/{eventId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Ä°stek ve Ã–neri Kutusu
    // TODO: Production'da adminUIDs kontrolÃ¼ eklenecek
    // Åu an app-level admin kontrolÃ¼ yeterli (sadece admin panel okuyabiliyor)
    match /user_feedbacks/{feedbackId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null;
    }

    // ğŸ“ KullanÄ±cÄ± NotlarÄ±
    match /user_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ§  AkÄ±llÄ± Ders NotlarÄ± (KampÃ¼s ModÃ¼lÃ¼)
    match /smart_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ“š KampÃ¼s - Dersler
    match /courses/{courseId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ“ KampÃ¼s - Ders NotlarÄ±
    match /course_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸŒŸ Feature KartlarÄ± (Remote Config - Home Screen)
    match /feature_cards/{cardId} {
      allow read: if request.auth != null;
      allow write: if false; // Sadece admin konsoldan
    }

    // ğŸ† AltÄ±n Soru BankasÄ± (Smart Memory - Golden DB)
    match /golden_questions/{questionId} {
      allow read: if request.auth != null; // Herkes okuyabilir (RAG iÃ§in)
      allow create: if request.auth != null; // KullanÄ±cÄ±lar doÄŸrulama sonrasÄ± ekleyebilir
      allow update: if request.auth != null; // KullanÄ±m sayÄ±sÄ± vb.
    }

    // â³ Bekleyen Sorular (Smart Memory - Pending DB)
    match /pending_questions/{questionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null; // Auto-promote veya admin silme
    }
  }
}
