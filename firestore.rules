rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // KullanÄ±cÄ±lar koleksiyonu
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // DeviceId ile arama iÃ§in
      allow read: if request.auth != null;
      
      // SM-2 Spaced Repetition KartlarÄ±
      match /sm2_cards/{cardId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // GÃ¼nlÃ¼k Ã‡alÄ±ÅŸma PlanlarÄ±
      match /daily_plans/{planId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Sistem yapÄ±landÄ±rmasÄ± (Admin kodu vb.)
    match /configs/settings {
      allow read: if request.auth != null;
    }

    // YarÄ±ÅŸmalar Ã¶dÃ¼l duyurusu (admin panelden dÃ¼zenlenir)
    match /configs/competitions_award {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    // User DNA - Veri BankasÄ±
    // Test: GiriÅŸ yapmÄ±ÅŸ herkes okuyabiliyor; admin paneli uygulama iÃ§inde ÅŸifre ile korunuyor.
    // Production'da istenirse: read sadece adminUIDs iÃ§in kÄ±sÄ±tlanabilir.
    match /user_dna/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // KullanÄ±cÄ± PuanlarÄ±
    match /user_points/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Ä°ÅŸlem geÃ§miÅŸi
      match /transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Sorular koleksiyonu  
    match /questions/{questionId} {
      allow read: if request.auth != null 
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null 
                    && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null 
                    && resource.data.userId == request.auth.uid;
      allow delete: if false;
    }
    
    // Spaced Repetition - Tekrar KartlarÄ±
    match /user_reviews/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /cards/{cardId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Duyurular - Herkes okusun
    match /announcements/{announcementId} {
      allow read: if true;
      allow write: if false;
    }
    
    // GÃ¼nlÃ¼k Snapshots
    match /daily_snapshots/{snapshotId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Soru OturumlarÄ±
    match /question_sessions/{sessionId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
    
    // Ã–ÄŸrenme Etkinlikleri
    match /learning_events/{eventId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Ä°stek ve Ã–neri Kutusu
    // TODO: Production'da adminUIDs kontrolÃ¼ eklenecek
    // Åu an app-level admin kontrolÃ¼ yeterli (sadece admin panel okuyabiliyor)
    match /user_feedbacks/{feedbackId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null;
    }

    // ğŸ“ KullanÄ±cÄ± NotlarÄ±
    match /user_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ§  AkÄ±llÄ± Ders NotlarÄ± (KampÃ¼s ModÃ¼lÃ¼)
    match /smart_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ“š KampÃ¼s - Dersler
    match /courses/{courseId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ“ KampÃ¼s - Ders NotlarÄ±
    match /course_notes/{noteId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create, update: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸŒŸ Feature KartlarÄ± (Remote Config - Home Screen)
    // Test: GiriÅŸ yapmÄ±ÅŸ herkes yazabiliyor; admin paneli uygulama iÃ§inde ÅŸifre ile korunuyor.
    // Production'da istenirse: allow write: if request.auth.uid in get(.../configs/settings).data.adminUIDs;
    match /feature_cards/{cardId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ğŸ† AltÄ±n Soru BankasÄ± (Smart Memory - Golden DB)
    match /golden_questions/{questionId} {
      allow read: if request.auth != null; // Herkes okuyabilir (RAG iÃ§in)
      allow create: if request.auth != null; // KullanÄ±cÄ±lar doÄŸrulama sonrasÄ± ekleyebilir
      allow update: if request.auth != null; // KullanÄ±m sayÄ±sÄ± vb.
    }

    // â³ Bekleyen Sorular (Smart Memory - Pending DB)
    match /pending_questions/{questionId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null; // Auto-promote veya admin silme
    }

    // ğŸ† Liderlik Tablosu - TÃ¼m Zamanlar
    match /leaderboard/allTime/entries/{userId} {
      allow read: if request.auth != null; // Herkes liderlik tablosunu gÃ¶rebilir
      allow create, update: if request.auth != null && request.auth.uid == userId; // Sadece kendi puanÄ±nÄ± deÄŸiÅŸtirebilir
      allow delete: if false;
    }

    // ğŸ† Liderlik Tablosu - HaftalÄ±k
    match /leaderboard/weekly/entries/{userId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // ğŸš© Hile Flag Sistemi
    match /leaderboard/flags/users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId; // Kendi flag'ini gÃ¶rebilir
      allow create, update: if request.auth != null && request.auth.uid == userId; // Kendi flag'ini gÃ¼ncelleyebilir
      allow delete: if false; // Sadece admin silebilir
    }

    // âš”ï¸ Challenge - Soru Havuzu (sadece okuma uygulama, yazma Admin/Console)
    match /challenge_questions/{questionId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // âš”ï¸ Challenge - YarÄ±ÅŸmalar
    match /challenges/{challengeId} {
      allow read, create, update: if request.auth != null;
      allow delete: if false;
    }

    // âš”ï¸ Challenge - KullanÄ±cÄ± Ä°statistikleri (Liderboard iÃ§in tÃ¼m kullanÄ±cÄ±lar okuyabilir)
    match /user_challenge_stats/{userId} {
      allow read: if request.auth != null; // Liderboard listesi iÃ§in
      allow write: if request.auth != null && request.auth.uid == userId; // Sadece kendi kaydÄ±
    }

    // ğŸ’¬ Forum PaylaÅŸÄ±mlarÄ±
    match /forum_posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null; // commentCount gÃ¼ncelleme iÃ§in
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ğŸ’¬ Forum YorumlarÄ±
    match /forum_comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ğŸ“ Akademi - Anketler
    match /akademi_surveys/{surveyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow update: if request.auth != null; // responseCount, expiresAt, isPaid vb.
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
    }

    // ğŸ“ Akademi - Anket YanÄ±tlarÄ±
    match /akademi_responses/{responseId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }

    // ğŸ“š KÃ¼tÃ¼phane - ArkadaÅŸÄ±n Olacak havuzu
    match /library_buddy_pool/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“š KÃ¼tÃ¼phane - ArkadaÅŸÄ±n Olacak eÅŸleÅŸmeleri
    match /library_buddy_matches/{matchId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null;
      allow delete: if false;
      // Mesajlar (eÅŸleÅŸen kullanÄ±cÄ±lar okuyabilir, yazabilir; eski mesaj temizliÄŸi iÃ§in delete)
      match /messages/{messageId} {
        allow read, create: if request.auth != null
          && (get(/databases/$(database)/documents/library_buddy_matches/$(matchId)).data.user1Id == request.auth.uid
              || get(/databases/$(database)/documents/library_buddy_matches/$(matchId)).data.user2Id == request.auth.uid);
        allow update: if false;
        allow delete: if request.auth != null
          && (get(/databases/$(database)/documents/library_buddy_matches/$(matchId)).data.user1Id == request.auth.uid
              || get(/databases/$(database)/documents/library_buddy_matches/$(matchId)).data.user2Id == request.auth.uid);
      }
    }

    // ğŸ“š KÃ¼tÃ¼phane - Mesaj ÅŸablonlarÄ± (sadece okuma; admin Firestore Console'dan ekler)
    match /library_message_templates/{templateId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ğŸ”” FCM token'larÄ± (push bildirim - gÃ¼ncelleme/duyuru)
    match /user_fcm_tokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ“š KÃ¼tÃ¼phane - KayÄ±tlÄ± yanÄ±tlar (KayÄ±tlÄ± NotlarÄ±m)
    match /library_saved_answers/{answerId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if false;
    }
  }
}
